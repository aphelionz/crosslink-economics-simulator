<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Crosslink Economics Simulator</title>
    <style>
      :root {
        color-scheme: dark;
        --surface: #111827;
        --surface-alt: #070b16;
        --text: #f8fafc;
        --muted: #94a3b8;
        --border: rgba(148, 163, 184, 0.25);
        --accent: #f59e0b;
        --accent-soft: rgba(245, 158, 11, 0.18);
        --warning: #facc15;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      h2 {
        margin-top: 0;
      }
      body {
        margin: 0;
        background: var(--surface-alt);
        color: var(--text);
      }
      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 3rem;
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
      }
      .page-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 1rem 1.5rem;
        align-items: flex-start;
      }
      .page-header-text {
        flex: 1 1 320px;
        min-width: 260px;
      }
      header h1 {
        font-size: clamp(2rem, 5vw, 2.6rem);
        margin: 0;
      }
      header p {
        margin: 0.5rem 0 0;
        max-width: 80ch;
        color: var(--muted);
        line-height: 1.5;
      }
      .page-header-actions {
        display: flex;
        align-items: flex-start;
      }
      .page-header-actions button {
        white-space: nowrap;
      }
      header p strong,
      .accent {
        color: var(--accent);
      }
      .accent,
      .summary-strong {
        font-weight: 600;
      }
      .panel {
        background: var(--surface);
        border-radius: 18px;
        padding: 1.75rem;
        box-shadow: 0 24px 60px rgba(2, 6, 23, 0.45);
        border: 1px solid var(--border);
      }
      .panel-intro {
        display: grid;
        gap: 1.75rem;
      }
      .intro-copy {
        color: var(--muted);
        font-size: 1.5rem;
        line-height: 1.6;
      }
      .simulator-disclaimer {
        margin: 1.25rem 0 0;
        font-size: 0.92rem;
        color: var(--muted);
        line-height: 1.4;
      }
      form.controls {
        display: grid;
        gap: 1.5rem;
      }
      fieldset {
        margin: 0;
        padding: 0;
        border: none;
        display: grid;
        gap: 0.75rem;
      }
      fieldset legend {
        font-weight: 600;
        font-size: 1.05rem;
        margin-bottom: 0.25rem;
      }
      .field {
        display: grid;
        gap: 0.35rem;
      }
      .selection-dynamics {
        display: grid;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .selection-dynamics-title {
        font-size: 0.82rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .selection-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.75rem;
      }
      .selection-label {
        font-size: 0.82rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .selection-value {
        font-weight: 600;
        font-size: 1.05rem;
        text-align: right;
      }
      small {
        color: var(--muted);
      }
      .inline-note {
        color: var(--muted);
        font-size: 0.82rem;
        margin-top: 0.2rem;
      }
      label {
        font-size: 0.92rem;
        color: var(--muted);
      }
      select,
      input[type="number"] {
        appearance: none;
        font: inherit;
        padding: 0.55rem 0.65rem;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.65);
        color: var(--text);
      }
      input[type="range"] {
        width: 100%;
        margin: 0.35rem 0;
      }
      input[type="range"].warning {
        accent-color: var(--warning);
      }
      .warning-note {
        color: var(--warning);
        font-weight: 600;
      }
      input[type="number"]:focus,
      select:focus {
        outline: 2px solid rgba(245, 158, 11, 0.45);
        outline-offset: 2px;
      }
      button {
        font: inherit;
        border: 1px solid transparent;
        border-radius: 999px;
        padding: 0.55rem 1.15rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: var(--accent-soft);
        color: var(--accent);
        cursor: pointer;
        transition: background 150ms ease, transform 150ms ease;
      }
      button:hover {
        background: rgba(245, 158, 11, 0.28);
      }
      button:active {
        transform: scale(0.98);
      }
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 0.5rem;
      }
      .visually-hidden {
        position: absolute !important;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      @media (min-width: 720px) {
        .panel-intro {
          grid-template-columns: 1fr 445px;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="page-header">
        <div class="page-header-text">
          <h1>Crosslink Economics Simulator</h1>
          <p>The Crosslink v1 economics, demonstrated simply.</p>
        </div>
        <div class="page-header-actions">
          <button type="button" id="copy-link-button">ðŸ”— Share scenario</button>
        </div>
      </header>

      <div class="panel-intro">
        <div class="intro-copy">
          <p>
            If there are <span id="sumTotalShielded" class="accent summary-strong" title="1,123,000 ZEC"></span> ZEC in the Orchard Pool,
            and <abbr id="sumPctStaked" class="accent" title="1,234,234 ZEC"></abbr>% of that is staked,
            you can contribute <span id="sumDelegationZec" class="accent"></span> ZEC
            and earn roughly:
            <ul>
              <li><span id="sumDailyYieldZec" class="accent summary-strong"></span> ZEC per day</li>
              <li><span id="sumAnnualYieldZec" class="accent summary-strong"></span> ZEC per year</li>
              <li>or about <span id="sumAnnualizedPct" class="accent summary-strong"></span>% annualized.</li>
            </ul>
          </p>
          <p class="simulator-disclaimer">
            This simulator provides illustrative estimates only. It is not investment, financial, or legal advice, and real-world outcomes may differ.
          </p>
        </div>
        <div style="display: none">
          Including your delegation, total staked comes to <span id="sumTotalStakedZec" class="summary-strong"></span> ZEC.
          (~<span id="sumStakedZec" class="summary-strong"></span> ZEC before your delegation)
          <span id="commission" class="accent"></span>%
        </div>
        <section class="panel">
          <h2>Configure Scenario</h2>
          <form class="controls" id="controls" autocomplete="off">
            <fieldset>
              <div class="field">
                <label for="inputPctStaked" title="What portion of all shielded ZEC participates in staking?">% of shielded pool staked</label>
                <input id="inputPctStaked" name="pct-staked" type="range" min="0" max="100" step="0.1">
                <small id="pctStakedWarning" class="inline-note warning-note" hidden>Warning: Staking Centralization Risk</small>
              </div>
              <div class="field">
                <label for="commissionInput">Finalizer Commission (%)</label>
                <input id="commissionInput" name="commission" type="number" min="0" max="100" step="0.1" inputmode="decimal">
              </div>
              <div class="field">
                <label for="delegator">Your Delegation (ZEC)</label>
                <select id="delegator" name="delegator">
                  <option value="0.1">0.1 ZEC</option>
                  <option value="1">1 ZEC</option>
                  <option value="10">10 ZEC</option>
                  <option value="100">100 ZEC</option>
                  <option value="1000">1,000 ZEC</option>
                  <option value="10000">10,000 ZEC</option>
                  <option value="100000">100,000 ZEC</option>
                </select>
                <small id="delegatorCoverageNote" class="inline-note" hidden>You now match the entire staked pool.</small>
              </div>
              <div class="button-row">
                <button type="button" id="reset-button">Reset to defaults</button>
              </div>
            </fieldset>
          </form>
        </section>
      </div>

    </main>

    <script>
      (() => {
        const ROUND_REWARD_ZEC = 1.5625;
        const ROUNDS_PER_DAY = 1152;
        const DAYS_PER_YEAR = 365;
        const SHARE_STAKERS = 0.40;
        const TOTAL_SHIELDED_ZEC = 3_000_000;
        const REWARD_PER_DAY = ROUND_REWARD_ZEC * SHARE_STAKERS * ROUNDS_PER_DAY;
        const DELEGATION_LEVELS = [0.1, 1, 10, 100, 1_000, 10_000, 100_000];

        const DEFAULTS = {
          commissionPct: 10,
          delegatorZec: DELEGATION_LEVELS[2],
          pctShieldedStaked: 50,
        };

        const state = { ...DEFAULTS };

        const zecFormatter = new Intl.NumberFormat(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 6,
        });
        const intFormatter = new Intl.NumberFormat(undefined, {
          maximumFractionDigits: 0,
        });
        const pctFormatter = new Intl.NumberFormat(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2,
        });
        const pctStakedInput = document.getElementById("inputPctStaked");
        const commissionInput = document.getElementById("commissionInput");
        const delegatorInput = document.getElementById("delegator");
        const resetButton = document.getElementById("reset-button");
        const copyLinkButton = document.getElementById("copy-link-button");

        const summaryElements = {
          totalShielded: document.getElementById("sumTotalShielded"),
          pctStaked: document.getElementById("sumPctStaked"),
          stakedZec: document.getElementById("sumStakedZec"),
          totalStakedZec: document.getElementById("sumTotalStakedZec"),
          delegationZec: document.getElementById("sumDelegationZec"),
          commission: document.getElementById("commission"),
          dailyYieldZec: document.getElementById("sumDailyYieldZec"),
          annualYieldZec: document.getElementById("sumAnnualYieldZec"),
          annualizedPct: document.getElementById("sumAnnualizedPct"),
        };
        const coverageNote = document.getElementById("delegatorCoverageNote");
        const pctStakedWarningNote = document.getElementById("pctStakedWarning");

        function clamp(value, min, max = Number.POSITIVE_INFINITY) {
          if (!Number.isFinite(value)) return min;
          return Math.min(max, Math.max(min, value));
        }

        function updateState(key, rawValue) {
          if (!Number.isFinite(rawValue)) return false;
          let next = rawValue;
          if (key === "delegatorZec") {
            next = snapDelegationValue(Math.max(0, next));
          } else if (key === "pctShieldedStaked" || key === "commissionPct") {
            next = clamp(next, 0, 100);
          }
          if (state[key] === next) {
            return false;
          }
          state[key] = next;
          return true;
        }

        function fmtZec(value) {
          if (!Number.isFinite(value)) return "â€“";
          const rounded = Math.round(value * 1e6) / 1e6;
          return zecFormatter.format(rounded);
        }

        function fmtInt(value) {
          if (!Number.isFinite(value)) return "â€“";
          return intFormatter.format(Math.round(value));
        }

        function fmtPct(value) {
          if (!Number.isFinite(value)) return "â€“";
          const rounded = Math.round(value * 100) / 100;
          return pctFormatter.format(rounded);
        }

        function snapDelegationValue(value) {
          if (!Number.isFinite(value)) {
            return DELEGATION_LEVELS[0];
          }
          let closest = DELEGATION_LEVELS[0];
          for (const level of DELEGATION_LEVELS) {
            if (Math.abs(value - level) < Math.abs(value - closest)) {
              closest = level;
            }
          }
          return closest;
        }

        function derive(currentState) {
          const pctShieldedStaked = currentState.pctShieldedStaked;
          const delegatorZec = currentState.delegatorZec;
          const totalShieldedZec = TOTAL_SHIELDED_ZEC;
          const stakedZec = (totalShieldedZec * pctShieldedStaked) / 100;
          const totalStakedZec = stakedZec + delegatorZec;
          const netFactor = 1 - currentState.commissionPct / 100;
          const delegatorShare = totalStakedZec > 0 ? delegatorZec / totalStakedZec : 0;
          const netDailyZec = REWARD_PER_DAY * delegatorShare * netFactor;
          const netAnnualZec = netDailyZec * DAYS_PER_YEAR;
          const annualizedPct = delegatorZec > 0 ? (netAnnualZec / delegatorZec) * 100 : 0;
          const coversStakedPool = stakedZec > 0 && delegatorZec >= stakedZec;

          return {
            totalShieldedZec,
            pctShieldedStaked,
            stakedZec,
            totalStakedZec,
            delegatorZec,
            commissionPct: currentState.commissionPct,
            netDailyZec,
            netAnnualZec,
            annualizedPct,
            coversStakedPool,
          };
        }

        function syncInputsFromState() {
          pctStakedInput.value = `${state.pctShieldedStaked}`;
          commissionInput.value = `${state.commissionPct}`;
          if (delegatorInput) {
            delegatorInput.value = `${state.delegatorZec}`;
          }
        }

        function syncURL(derived) {
          const url = new URL(window.location.href);
          url.searchParams.set("ps", state.pctShieldedStaked.toString());
          url.searchParams.set("c", state.commissionPct.toString());
          url.searchParams.set("dz", derived.delegatorZec.toString());
          const next = `${url.pathname}${url.search}${url.hash}`;
          const current = `${window.location.pathname}${window.location.search}${window.location.hash}`;
          if (next !== current) {
            history.replaceState(null, "", next);
          }
        }

        const copyButtonDefaultText = copyLinkButton ? copyLinkButton.textContent : "";
        let copyButtonResetTimer = null;

        function setCopyButtonLabel(label, revertDelay = 2000) {
          if (!copyLinkButton) return;
          copyLinkButton.textContent = label;
          if (copyButtonResetTimer) {
            window.clearTimeout(copyButtonResetTimer);
            copyButtonResetTimer = null;
          }
          if (revertDelay > 0) {
            copyButtonResetTimer = window.setTimeout(() => {
              copyLinkButton.textContent = copyButtonDefaultText;
              copyButtonResetTimer = null;
            }, revertDelay);
          }
        }

        function fallbackCopyText(value) {
          const tempInput = document.createElement("input");
          tempInput.value = value;
          tempInput.setAttribute("readonly", "");
          tempInput.style.position = "absolute";
          tempInput.style.left = "-9999px";
          document.body.appendChild(tempInput);
          tempInput.select();
          tempInput.setSelectionRange(0, tempInput.value.length);
          const success = document.execCommand("copy");
          document.body.removeChild(tempInput);
          return success;
        }

        async function copyScenarioLink() {
          if (!copyLinkButton) return;
          const urlToCopy = window.location.href;
          try {
            if (navigator.clipboard?.writeText) {
              await navigator.clipboard.writeText(urlToCopy);
              setCopyButtonLabel("Copied!");
              return;
            }
          } catch (error) {
            // Ignore and attempt fallback below.
          }
          const success = fallbackCopyText(urlToCopy);
          if (success) {
            setCopyButtonLabel("Copied!");
          } else {
            setCopyButtonLabel("Copy failed", 2000);
          }
        }

        function render(derived) {
          summaryElements.totalShielded.textContent = fmtInt(derived.totalShieldedZec);
          summaryElements.pctStaked.textContent = fmtPct(derived.pctShieldedStaked);
          summaryElements.pctStaked.title = `${fmtZec(derived.stakedZec)} ZEC`;
          summaryElements.stakedZec.textContent = fmtZec(derived.stakedZec);
          summaryElements.totalStakedZec.textContent = fmtZec(derived.totalStakedZec);
          summaryElements.delegationZec.textContent = fmtZec(derived.delegatorZec);
          summaryElements.commission.textContent = fmtPct(derived.commissionPct);
          summaryElements.dailyYieldZec.textContent = fmtZec(derived.netDailyZec);
          summaryElements.annualYieldZec.textContent = fmtZec(derived.netAnnualZec);
          summaryElements.annualizedPct.textContent = fmtPct(derived.annualizedPct);
          updatePctStakedWarning(derived.pctShieldedStaked);
          if (coverageNote) {
            coverageNote.hidden = !derived.coversStakedPool;
          }
        }

        function updatePctStakedWarning(value) {
          const lowStaked = value <= 10;
          const highStaked = value > 70;
          const warningActive = lowStaked || highStaked;
          pctStakedInput.classList.toggle("warning", warningActive);
          if (pctStakedWarningNote) {
            pctStakedWarningNote.hidden = !warningActive;
            if (warningActive) {
              pctStakedWarningNote.textContent = lowStaked
                ? "Warning: Staking Centralization Risk"
                : "Important: Potential Privacy leakage";
            }
          }
        }

        function propagateStateChange(options = {}) {
          if (options.syncInputs) {
            syncInputsFromState();
          }
          const derived = derive(state);
          render(derived);
          if (!options.skipURL) {
            syncURL(derived);
          }
          return derived;
        }

        function applyStateFromQuery() {
          const params = new URLSearchParams(window.location.search);

          updateState("pctShieldedStaked", Number.parseFloat(params.get("ps") ?? ""));
          updateState("commissionPct", Number.parseFloat(params.get("c") ?? ""));

          if (params.has("dz")) {
            updateState("delegatorZec", Number.parseFloat(params.get("dz")));
          }
        }

        pctStakedInput.addEventListener("input", () => {
          if (updateState("pctShieldedStaked", pctStakedInput.valueAsNumber)) {
            propagateStateChange();
          }
        });

        commissionInput.addEventListener("input", () => {
          if (updateState("commissionPct", commissionInput.valueAsNumber)) {
            propagateStateChange();
            commissionInput.value = state.commissionPct;
          }
        });

        commissionInput.addEventListener("blur", () => {
          if (!Number.isFinite(commissionInput.valueAsNumber)) {
            commissionInput.value = state.commissionPct;
          }
        });

        delegatorInput.addEventListener("change", () => {
          const parsed = Number.parseFloat(delegatorInput.value);
          const changed = updateState("delegatorZec", parsed);
          delegatorInput.value = `${state.delegatorZec}`;
          if (changed) {
            propagateStateChange();
          }
        });

        resetButton.addEventListener("click", () => {
          Object.assign(state, DEFAULTS);
          propagateStateChange({ syncInputs: true });
        });

        if (copyLinkButton) {
          copyLinkButton.addEventListener("click", () => {
            const derived = derive(state);
            syncURL(derived);
            copyScenarioLink();
          });
        }

        applyStateFromQuery();
        const initialDerived = propagateStateChange({ syncInputs: true, skipURL: true });
        syncURL(initialDerived);
      })();
    </script>
  </body>
</html>
